(function(a,b){'object'==typeof exports&&'object'==typeof module?module.exports=b():'function'==typeof define&&define.amd?define([],b):'object'==typeof exports?exports.Civ5Save=b():a.Civ5Save=b()})(this,function(){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a['default']}:function(){return a};return b.d(c,'a',c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p='',b(b.s=0)}([function(a,b,c){'use strict';function d(a,b){return a.length==b.length&&a.every(function(a,c){return a===b[c]})}function e(a){return'undefined'==typeof a||null===a}var f=String.fromCharCode;Object.defineProperty(b,'__esModule',{value:!0});var g=c(1),h=c.n(g);class i{constructor(a){this._saveData=new j(a.buffer),this._verifyFileSignature(),this._properties=this._getProperties()}static async fromFile(a){let b=await i.loadData(a);return new i(b)}static loadData(a){return new Promise(function(b,c){let d=new FileReader;d.onload=function(){b(new DataView(d.result))},d.onerror=function(){c(d.error)},d.readAsArrayBuffer(a)})}toFile(a){return new File([this._saveData],a,{type:'application/octet-stream'})}_verifyFileSignature(){if('CIV5'!==this._saveData.getString(0,4))throw new Error('File signature does not match. Is this a Civ 5 savegame?')}_getProperties(){let a='',b=0,c=new Map,d=this._getSectionOffsets();for(let f in h.a){let g=Object.assign({},h.a[f]),i=this._getPropertySection(g);if(e(i))continue;let j=null;if(i===b){let b=c[a];try{j=b.byteOffset+b.length}catch(a){break}}else j=d[i-1].start+g.byteOffsetInSection;c[f]=k.fromType(g.type,j,g.length,this._saveData),a=f,b=i}return c}_getSectionOffsets(){const a=[64,0,0,0],b=h.a[Object.keys(h.a)[Object.keys(h.a).length-1]],c=b.sectionByBuild[Object.keys(b.sectionByBuild)[Object.keys(b.sectionByBuild).length-1]];let e=new Int8Array(this._saveData.buffer),f=[];f.push({start:0});for(let b=0;b<e.length;b++)if(d(e.slice(b,b+4),a)){if(310700>+this.gameBuild){let a=23;if(262623<=+this.gameBuild&&(a=24),f.length===a&&270>b-f[f.length-1].start)continue}let a={start:b};if(f.push(a),f[f.length-2].end=b-1,f.length===c)break}return f}_getPropertySection(a){var b=Number.parseInt;let c=null;for(let d in a.sectionByBuild)b(this.gameBuild)>=b(d)&&(c=a.sectionByBuild[d]);return c}get gameBuild(){return e(this._gameBuild)&&(this._gameBuild=this._getGameBuild()),this._gameBuild}_getGameBuild(){const a='FINAL_RELEASE',b=function(){let b=[];for(let c=0;c<a.length;c++)b.push(a.charCodeAt(c));return b}();let c=0,e=new Int8Array(this._saveData.buffer);for(let a=0;a<=e.length;a++)if(d(e.slice(a,a+b.length),b)){c=a;break}let g='',h=c-2;for(;0!==e.slice(h,h+1)[0];)g=f(e.slice(h,h+1))+g,h--;return g}get gameVersion(){return this._returnPropertyIfDefined('gameVersion')}get currentTurn(){return this._properties.currentTurn.value}get gameMode(){if(230620<=+this.gameBuild)return h.a.gameMode.values[this._properties.gameMode.value]}get player1Civilization(){return this._returnPropertyIfDefined('player1Civilization')}get difficulty(){return this._returnPropertyIfDefined('difficulty')}get startingEra(){return this._returnPropertyIfDefined('startingEra')}get currentEra(){return this._returnPropertyIfDefined('currentEra')}get gamePace(){return this._returnPropertyIfDefined('gamePace')}get mapSize(){return this._returnPropertyIfDefined('mapSize')}get mapFile(){return this._returnPropertyIfDefined('mapFile')}get maxTurns(){return this._returnPropertyIfDefined('maxTurns')}set maxTurns(a){this._properties.maxTurns.value=a}get timeVictory(){return this._returnPropertyIfDefined('timeVictory')}set timeVictory(a){this._properties.timeVictory.value=a}get scienceVictory(){return this._returnPropertyIfDefined('scienceVictory')}set scienceVictory(a){this._properties.scienceVictory.value=a}get dominationVictory(){return this._returnPropertyIfDefined('dominationVictory')}set dominationVictory(a){this._properties.dominationVictory.value=a}get culturalVictory(){return this._returnPropertyIfDefined('culturalVictory')}set culturalVictory(a){this._properties.culturalVictory.value=a}get diplomaticVictory(){return this._returnPropertyIfDefined('diplomaticVictory')}set diplomaticVictory(a){this._properties.diplomaticVictory.value=a}_returnPropertyIfDefined(a){if(this._properties.hasOwnProperty(a))return this._properties[a].value}}b['default']=i;class j extends DataView{getBoolean(a){return!!this.getUint8(a)}setBoolean(a,b){this.setUint8(a,+b)}getString(a,b){let c='';for(let d=a;d<a+b;d++)c+=f(this.getUint8(d));return c}}class k{constructor(a,b,c){this.byteOffset=a,this._length=b,this.saveData=c}get length(){return this._length}static fromType(a,b,c,d){switch(a){case'bool':return new l(b,1,d);case'bytes':return new k(b,c,d);case'int8':return new m(b,1,d);case'int32':return new n(b,4,d);case'string':return new o(b,c,d);default:throw new Error(`Property type ${a} not handled`);}}}class l extends k{get value(){return this.saveData.getBoolean(this.byteOffset)}set value(a){this.saveData.setBoolean(this.byteOffset,a)}}class m extends k{get value(){return this.saveData.getUint8(this.byteOffset)}set value(a){this.saveData.setUint8(this.byteOffset,a)}}class n extends k{get value(){return this.saveData.getUint32(this.byteOffset,!0)}set value(a){this.saveData.setUint32(this.byteOffset,a,!0)}}class o extends k{get length(){return e(this._length)&&(this._length=this.getStringLength(this.byteOffset)+4),this._length}get value(){return this.saveData.getString(this.byteOffset+4,this.length-4)}getStringLength(a){return this.saveData.getUint32(a,!0)}}},function(a){a.exports={fileSignature:{byteOffsetInSection:0,length:4,sectionByBuild:{200405:1},type:'string'},saveGameVersion:{byteOffsetInSection:4,length:4,sectionByBuild:{200405:1},type:'int32'},gameVersion:{byteOffsetInSection:8,length:null,sectionByBuild:{230620:1},type:'string'},gameBuild:{byteOffsetInSection:null,length:null,sectionByBuild:{230620:1},type:'string'},currentTurn:{byteOffsetInSection:null,length:4,sectionByBuild:{200405:1},type:'int32'},gameMode:{_comment:'This property exists in all versions but only seems to gain significance around build 230620',byteOffsetInSection:null,length:1,sectionByBuild:{200405:1},type:'int8',values:['singleplayer','multiplayer','hotseat']},player1Civilization:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:1},type:'string'},difficulty:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:1},type:'string'},startingEra:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:1},type:'string'},currentEra:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:1},type:'string'},gamePace:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:1},type:'string'},mapSize:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:1},type:'string'},mapFile:{_comment:'The map file appears multiple times; I have no idea why (see section19Map)',byteOffsetInSection:null,length:null,sectionByBuild:{200405:1},type:'string'},section19Skip1:{byteOffsetInSection:264,length:null,sectionByBuild:{200405:17,262623:18,395070:19},type:'string'},section19Skip2:{byteOffsetInSection:null,length:7,sectionByBuild:{200405:17,262623:18,395070:19},type:'bytes'},section19Map:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:17,262623:18,395070:19},type:'string'},section19Skip3:{byteOffsetInSection:null,length:4,sectionByBuild:{200405:17,262623:18,395070:19},type:'bytes'},maxTurns:{_comment:'https://gaming.stackexchange.com/a/273907/154341',byteOffsetInSection:null,length:4,sectionByBuild:{200405:17,262623:18,395070:19},type:'int32'},section29Timer1:{byteOffsetInSection:269,length:null,sectionByBuild:{200405:27,262623:28,395070:29},type:'string'},section29Skip1:{byteOffsetInSection:null,length:12,sectionByBuild:{200405:27,262623:28,395070:29},type:'bytes'},section29TurnTimer:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:27,262623:28,395070:29},type:'string'},section29TxtKeyTurnTimer:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:27,262623:28,395070:29},type:'string'},section29Timer2:{byteOffsetInSection:null,length:null,sectionByBuild:{200405:27,262623:28,395070:29},type:'string'},section29Skip2:{byteOffsetInSection:null,length:25,sectionByBuild:{200405:27,262623:28,395070:29},type:'bytes'},timeVictory:{_comment:'https://gaming.stackexchange.com/a/273907/154341',byteOffsetInSection:null,length:1,sectionByBuild:{200405:27,262623:28,395070:29},type:'bool'},scienceVictory:{_comment:'https://gaming.stackexchange.com/a/273907/154341',byteOffsetInSection:null,length:1,sectionByBuild:{200405:27,262623:28,395070:29},type:'bool'},dominationVictory:{_comment:'https://gaming.stackexchange.com/a/273907/154341',byteOffsetInSection:null,length:1,sectionByBuild:{200405:27,262623:28,395070:29},type:'bool'},culturalVictory:{_comment:'https://gaming.stackexchange.com/a/273907/154341',byteOffsetInSection:null,length:1,sectionByBuild:{200405:27,262623:28,395070:29},type:'bool'},diplomaticVictory:{_comment:'https://gaming.stackexchange.com/a/273907/154341',byteOffsetInSection:null,length:1,sectionByBuild:{200405:27,262623:28,395070:29},type:'bool'}}}])});